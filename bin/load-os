#!/bin/bash

OS_IMAGE=${OS_IMAGE:-ArchLinuxARM-rpi-latest.tar.gz}
OS_URI=${OS_URI:-http://archlinuxarm.org/os/${OS_IMAGE}}
IMAGE_PATH=/build/"${OS_IMAGE}"

echo "#############################################"
echo "## Installing Operating System"
echo "#############################################"

echo "image path is ${IMAGE_PATH}"
if [[ ! -f "${IMAGE_PATH}" ]]; then
  echo "downloading..."
  wget -P /build/ "${OS_URI}" -q --show-progress
fi

echo "unpacking..."
file "${IMAGE_PATH}" | grep -qE '((XZ|gzip) compressed data|POSIX tar archive)'
test $? -eq 0 && pv -pe "/build/${OS_IMAGE}" | tar xzpf - -C mnt

file "${IMAGE_PATH}" | grep -q 'Zip archive data'
test $? -eq 0 && unzip -o "${IMAGE_PATH}" -d mnt | pv -l >/dev/null

echo "#############################################"
echo "## Tuning Operating System"
echo "#############################################"
mount -t proc none mnt/proc
mount -t sysfs none mnt/sys
mount -o rbind /dev mnt/dev
rm mnt/etc/resolv.conf
cp /etc/resolv.conf mnt/etc/resolv.conf
cp /usr/bin/qemu-arm-static mnt/usr/bin/

echo "completed tuning..."
