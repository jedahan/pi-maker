#!/bin/bash

IMAGE_NAME=${IMAGE_NAME:-rpi.img}

set -uo pipefail
trap 's=$?; echo "$0: Error on line "$LINENO": $BASH_COMMAND"; exit $s' ERR
IFS=$'\n\t'

cleanup() {
  test -d mnt/dev && umount mnt/dev
  test -d mnt/proc && umount mnt/proc
  test -d mnt/sys && umount mnt/sys
  test -d mnt/boot && umount mnt/boot
  if [[ -d mnt ]]; then
    umount mnt || true
    rmdir mnt
  fi
  loopdev=$(losetup --find --show "${IMAGE_NAME}")
  test -n "${loopdev}" && losetup --detach "${loopdev}"
}

trap cleanup EXIT

disk-init
load-os

# run custom setup script inside context of image
cp -rf /share/ mnt/
ls -al /mnt
bash
chroot mnt bash
cmd=$1
echo "running '$cmd'..."
chroot mnt $cmd

# now export the finalized image for flashing
mkdir -p /build
cp "${IMAGE_NAME}" /build/

echo "---------------------------------------------"
echo " ${IMAGE_NAME} is now ready for flashing"
echo "---------------------------------------------"
